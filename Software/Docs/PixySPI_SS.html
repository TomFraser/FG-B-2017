<!DOCTYPE html>

<html>
<head>
  <title>PixySPI_SS.h</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <meta name="viewport" content="width=device-width, target-densitydpi=160dpi, initial-scale=1.0; maximum-scale=1.0; user-scalable=0;">
  <link rel="stylesheet" media="all" href="docco.css" />
</head>
<body>
  <div id="container">
    <div id="background"></div>
    
      <ul id="jump_to">
        <li>
          <a class="large" href="javascript:void(0);">Jump To &hellip;</a>
          <a class="small" href="javascript:void(0);">+</a>
          <div id="jump_wrapper">
          <div id="jump_page_wrapper">
            <div id="jump_page">
              
                
                <a class="source" href="Buzzer.html">
                  Buzzer.cpp
                </a>
              
                
                <a class="source" href="Buzzer.html">
                  Buzzer.h
                </a>
              
                
                <a class="source" href="Compass.html">
                  Compass.cpp
                </a>
              
                
                <a class="source" href="Compass.html">
                  Compass.h
                </a>
              
                
                <a class="source" href="Config.html">
                  Config.h
                </a>
              
                
                <a class="source" href="Defines.html">
                  Defines.h
                </a>
              
                
                <a class="source" href="Pins.html">
                  Pins.h
                </a>
              
                
                <a class="source" href="DirectionController.html">
                  DirectionController.cpp
                </a>
              
                
                <a class="source" href="DirectionController.html">
                  DirectionController.h
                </a>
              
                
                <a class="source" href="Kicker.html">
                  Kicker.cpp
                </a>
              
                
                <a class="source" href="Kicker.html">
                  Kicker.h
                </a>
              
                
                <a class="source" href="Light.html">
                  Light.cpp
                </a>
              
                
                <a class="source" href="Light.html">
                  Light.h
                </a>
              
                
                <a class="source" href="Motor.html">
                  Motor.cpp
                </a>
              
                
                <a class="source" href="Motor.html">
                  Motor.h
                </a>
              
                
                <a class="source" href="Pixy.html">
                  Pixy.h
                </a>
              
                
                <a class="source" href="PixyI2C.html">
                  PixyI2C.h
                </a>
              
                
                <a class="source" href="PixySPI_SS.html">
                  PixySPI_SS.h
                </a>
              
                
                <a class="source" href="PixyUART.html">
                  PixyUART.h
                </a>
              
                
                <a class="source" href="TPixy.html">
                  TPixy.h
                </a>
              
                
                <a class="source" href="ReadTSOPS.html">
                  ReadTSOPS.cpp
                </a>
              
                
                <a class="source" href="ReadTSOPS.html">
                  ReadTSOPS.h
                </a>
              
                
                <a class="source" href="RotationController.html">
                  RotationController.cpp
                </a>
              
                
                <a class="source" href="RotationController.html">
                  RotationController.h
                </a>
              
                
                <a class="source" href="Vector3D.html">
                  Vector3D.h
                </a>
              
                
                <a class="source" href="t3spi.html">
                  t3spi.cpp
                </a>
              
                
                <a class="source" href="t3spi.html">
                  t3spi.h
                </a>
              
            </div>
          </div>
        </li>
      </ul>
    
    <ul class="sections">
        
          <li id="title">
              <div class="annotation">
                  <h1>PixySPI_SS.h</h1>
              </div>
          </li>
        
        
        
        <li id="section-1">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-1">&#182;</a>
              </div>
              <p>begin license header</p>
<p>This file is part of Pixy CMUcam5 or “Pixy” for short</p>
<p>All Pixy source code is provided under the terms of the
GNU General Public License v2 (<a href="http://www.gnu.org/licenses/gpl-2.0.html">http://www.gnu.org/licenses/gpl-2.0.html</a>).
Those wishing to use Pixy source code, software and/or
technologies under different licensing terms should contact us at
cmucam@cs.cmu.edu. Such licensing terms are available for
all portions of the Pixy codebase presented here.</p>
<p>end license header</p>
<p>This file is for defining the link class for SPI with Slave Select.  The 
default communication for Arduino is through the ICSP connector, which uses
SPI without a slave select.  The LinkSPI_SS allows you to use a slave select
so you can share the SPI port with other devices, or use multiple Pixys. </p>
<p>Note, the PixySPI_SS class takes an optional argument, which is the pin 
number of the slave select signal you wish to use.  The default pin is the 
SS pin (used when no argument is used.)  So, for example, if you wished to 
use pin 14 for slave select, declare like this:</p>
<p>PixySPI_SS pixy(14);</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>
<span class="hljs-meta">#ifndef PIXYSPI_SS_H</span>
<span class="hljs-meta">#define PIXYSPI_SS_H</span>

<span class="hljs-meta">#include <span class="hljs-meta-string">"TPixy.h"</span></span>
<span class="hljs-meta">#include <span class="hljs-meta-string">"SPI.h"</span></span>


<span class="hljs-meta">#define PIXY_SYNC_BYTE              0x5a</span>
<span class="hljs-meta">#define PIXY_SYNC_BYTE_DATA         0x5b</span>
<span class="hljs-meta">#define PIXY_OUTBUF_SIZE            6</span>

<span class="hljs-keyword">class</span> LinkSPI_SS
{
  public:
    <span class="hljs-keyword">void</span> init()
    {
      outLen = <span class="hljs-number">0</span>;
      SPI.begin();

      <span class="hljs-meta">#ifdef __SAM3X8E__</span></pre></div></div>
            
        </li>
        
        
        <li id="section-2">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-2">&#182;</a>
              </div>
              <p>DUE clock divider //</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      SPI.setClockDivider(<span class="hljs-number">84</span>);
      <span class="hljs-meta">#else</span></pre></div></div>
            
        </li>
        
        
        <li id="section-3">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-3">&#182;</a>
              </div>
              <p>Default clock divider //</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      SPI.setClockDivider(SPI_CLOCK_DIV16);
      <span class="hljs-meta">#endif</span>
    }
    
    uint16_t getWord()
    {</pre></div></div>
            
        </li>
        
        
        <li id="section-4">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-4">&#182;</a>
              </div>
              <p>ordering is different because Pixy is sending 16 bits through SPI 
instead of 2 bytes in a 16-bit word as with I2C</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>      uint16_t w;
      uint8_t c, cout = <span class="hljs-number">0</span>;</pre></div></div>
            
        </li>
        
        
        <li id="section-5">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-5">&#182;</a>
              </div>
              <p>assert slave select</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  digitalWrite(ssPin, LOW);

      <span class="hljs-keyword">if</span> (outLen)
      {
        w = SPI.transfer(PIXY_SYNC_BYTE_DATA);
        cout = outBuf[outIndex++];
        <span class="hljs-keyword">if</span> (outIndex==outLen)
          outLen = <span class="hljs-number">0</span>; 
      }
      <span class="hljs-keyword">else</span>
        w = SPI.transfer(<span class="hljs-number">0</span>);

      w &lt;&lt;= <span class="hljs-number">8</span>;
      c = SPI.transfer(cout);
      w |= c;</pre></div></div>
            
        </li>
        
        
        <li id="section-6">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-6">&#182;</a>
              </div>
              <p>negate slave select</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  digitalWrite(ssPin, HIGH);
      <span class="hljs-keyword">return</span> w;
    }
	
    uint8_t getByte() <span class="hljs-comment">// this shouldn't be called normally</span></pre></div></div>
            
        </li>
        
        
        <li id="section-7">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-7">&#182;</a>
              </div>
              <p>It should only be called if we get out of sync, but with slave select
we should stay in sync </p>

            </div>
            
            <div class="content"><div class='highlight'><pre>    {
	  uint8_t c;</pre></div></div>
            
        </li>
        
        
        <li id="section-8">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-8">&#182;</a>
              </div>
              <p>assert slave select</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  digitalWrite(ssPin, LOW);
      c = SPI.transfer(<span class="hljs-number">0x00</span>);</pre></div></div>
            
        </li>
        
        
        <li id="section-9">
            <div class="annotation">
              
              <div class="pilwrap ">
                <a class="pilcrow" href="#section-9">&#182;</a>
              </div>
              <p>negate slave select</p>

            </div>
            
            <div class="content"><div class='highlight'><pre>	  digitalWrite(ssPin, HIGH);
	  
	  <span class="hljs-keyword">return</span> c;
   }
    
    int8_t send(uint8_t *data, uint8_t len)
    {
      <span class="hljs-keyword">if</span> (len&gt;PIXY_OUTBUF_SIZE || outLen!=<span class="hljs-number">0</span>)
        <span class="hljs-keyword">return</span> <span class="hljs-number">-1</span>;
      memcpy(outBuf, data, len);
      outLen = len;
      outIndex = <span class="hljs-number">0</span>;
      <span class="hljs-keyword">return</span> len;
    }

    <span class="hljs-keyword">void</span> setArg(uint16_t arg)
    {
      <span class="hljs-keyword">if</span> (arg==PIXY_DEFAULT_ARGVAL)
        ssPin = SS; <span class="hljs-comment">// default slave select pin</span>
	  <span class="hljs-keyword">else</span>
	    ssPin = arg;
    }

  private:
    uint8_t outBuf[PIXY_OUTBUF_SIZE];
    uint8_t outLen;
    uint8_t outIndex;
	uint16_t ssPin;
};


<span class="hljs-keyword">typedef</span> TPixy&lt;LinkSPI_SS&gt; PixySPI_SS;

<span class="hljs-meta">#endif</span></pre></div></div>
            
        </li>
        
    </ul>
  </div>
</body>
</html>
